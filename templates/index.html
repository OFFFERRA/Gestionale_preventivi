<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Preventivi</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <!-- ======= FORM DI RICERCA ======= -->
    <h2>Ricerca Preventivo per Cliente</h2>
    <form action="{{ url_for('search_cliente') }}" method="GET" class="search-form">
        <div>
            <div>
                <label for="nomeCliente">Nome Cliente:</label>
                <input type="text" id="nomeCliente" name="nomeCliente" placeholder="Inserisci nome...">
            </div>

            <div>
                <label for="cognomeCliente">Cognome Cliente:</label>
                <input type="text" id="cognomeCliente" name="cognomeCliente" placeholder="Inserisci cognome...">
            </div>
        </div>
        <button type="submit">Cerca</button>
    </form>

    <!-- ======= RISULTATI RICERCA (Griglia compatta) ======= -->
    <div id="risultatiGrid" class="results-grid" data-has-results="{% if preventivi %}true{% else %}false{% endif %}">
      {% for preventivo in preventivi %}
      <div class="result-card"
           data-numero-ordine="{{ preventivo.numeroOrdine }}"
           data-nome-cliente="{{ preventivo.nomeCliente }}"
           data-cognome-cliente="{{ preventivo.cognomeCliente }}"
           data-nascita-cliente="{{ preventivo.nascitaCliente }}"
           data-codice-fiscale="{{ preventivo.codiceFiscale }}"
           data-tipo="{{ preventivo.tipo }}"
           data-codice="{{ preventivo.codice }}"
           data-descrizione="{{ preventivo.descrizione }}"
           data-unita-misura="{{ preventivo.unitaMisura }}"
           data-quantita="{{ preventivo.quantita }}"
           data-prezzo-unitario="{{ preventivo.prezzoUnitario }}"
           data-prezzo-totale="{{ preventivo.prezzoTotale }}"
           data-mr-prezzo-unitario="{{ preventivo.MRprezzoUnitario }}"
           data-mr-prezzo-totale="{{ preventivo.MRprezzoTotale }}"
           data-mr-ricarico="{{ preventivo.MRricarico }}"
           data-mano-r-prezzo-unitario="{{ preventivo.manoRprezzoUnitario }}"
           data-mano-r-prezzo-totale="{{ preventivo.manoRprezzoTotale }}"
           data-mano-r-ricarico="{{ preventivo.manoRricarico }}"
           data-pm-prezzo-unitario="{{ preventivo.PMprezzoUnitario }}"
           data-pm-prezzo-totale="{{ preventivo.PMprezzoTotale }}"
           data-cm-prezzo-unitario="{{ preventivo.CMprezzoUnitario }}"
           data-cm-prezzo-totale="{{ preventivo.CMprezzoTotale }}"
      >
        <div class="card-line"><span class="label">Ordine</span><span class="value">{{ preventivo.numeroOrdine }}</span></div>
        <div class="card-line"><span class="label">Tipo</span><span class="value">{{ preventivo.tipo }}</span></div>
        <div class="card-line row-actions">
          <span class="label">Codice</span>
          <span class="code-val">{{ preventivo.codice }}</span>
          <button type="button" class="btn btn-outline btn-sm view-details-btn">Dettagli</button>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- ======= FORM NUOVO PREVENTIVO (modal) ======= -->
    <button id="openModalBtn" class="btn">Aggiungi Preventivo</button>

    <!-- Stili del modal spostati in static/style.css -->

    <div id="preventivoModal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <button id="closeModalBtn" class="close" aria-label="Chiudi">&times;</button>
            <h2 id="modalTitle">Inserisci Nuovo Preventivo</h2>
            <form action="{{ url_for('add_preventivo') }}" method="POST" id="addPreventivoForm">
                <div>
                    <div>
                        <label for="nomeCliente">Nome Cliente:</label>
                        <input type="text" id="nomeCliente" name="nomeCliente" required>
                    </div>

                    <div>
                        <label for="cognomeCliente">Cognome Cliente:</label>
                        <input type="text" id="cognomeCliente" name="cognomeCliente" required>
                    </div>

                    <div>
                        <label for="nascitaCliente">Data di Nascita:</label>
                        <input type="date" id="nascitaCliente" name="nascitaCliente" required>
                    </div>

                    <div>
                        <label for="codiceFiscale">Codice Fiscale:</label>
                        <input type="text" id="codiceFiscale" name="codiceFiscale" required>
                    </div>

                    <div>
                        <label for="tipo">Tipo:</label>
                        <input type="text" id="tipo" name="tipo" required>
                    </div>

                    <div>
                        <label for="codice">Codice:</label>
                        <input type="number" id="codice" name="codice" required>
                    </div>

                    <div>
                        <label for="descrizione">Descrizione:</label>
                        <input type="text" id="descrizione" name="descrizione" required>
                    </div>

                    <div>
                        <label for="unitaMisura">Unità Misura:</label>
                        <input type="text" id="unitaMisura" name="unitaMisura" required>
                    </div>

                    <div>
                        <label for="quantita">Quantità:</label>
                        <input type="number" id="quantita" name="quantita" required>
                    </div>

                    <div>
                        <label for="prezzoUnitario">Prezzo Unitario:</label>
                        <input type="number" id="prezzoUnitario" name="prezzoUnitario" required>
                    </div>

                    <div>
                        <label for="prezzoTotale">Prezzo Totale:</label>
                        <input type="number" id="prezzoTotale" name="prezzoTotale" required>
                    </div>

                    <div>
                        <label for="MRprezzoUnitario">MR Prezzo Unitario:</label>
                        <input type="number" id="MRprezzoUnitario" name="MRprezzoUnitario" required>
                    </div>

                    <div>
                        <label for="MRprezzoTotale">MR Prezzo Totale:</label>
                        <input type="number" id="MRprezzoTotale" name="MRprezzoTotale" required>
                    </div>

                    <div>
                        <label for="MRricarico">MR Ricarico (%):</label>
                        <input type="number" id="MRricarico" name="MRricarico" required>
                    </div>

                    <div>
                        <label for="manoRprezzoUnitario">Mano R Prezzo Unitario:</label>
                        <input type="number" id="manoRprezzoUnitario" name="manoRprezzoUnitario" required>
                    </div>

                    <div>
                        <label for="manoRprezzoTotale">Mano R Prezzo Totale:</label>
                        <input type="number" id="manoRprezzoTotale" name="manoRprezzoTotale" required>
                    </div>

                    <div>
                        <label for="manoRricarico">Mano R Ricarico (%):</label>
                        <input type="number" id="manoRricarico" name="manoRricarico" required>
                    </div>

                    <div>
                        <label for="PMprezzoUnitario">PM Prezzo Unitario:</label>
                        <input type="number" id="PMprezzoUnitario" name="PMprezzoUnitario" required>
                    </div>

                    <div>
                        <label for="PMprezzoTotale">PM Prezzo Totale:</label>
                        <input type="number" id="PMprezzoTotale" name="PMprezzoTotale" required>
                    </div>

                    <div>
                        <label for="CMprezzoUnitario">CM Prezzo Unitario:</label>
                        <input type="number" id="CMprezzoUnitario" name="CMprezzoUnitario" required>
                    </div>

                    <div>
                        <label for="CMprezzoTotale">CM Prezzo Totale:</label>
                        <input type="number" id="CMprezzoTotale" name="CMprezzoTotale" required>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" id="clearFormBtn" class="btn btn-outline">Svuota Campi</button>
                    <button type="submit">Inserisci Preventivo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ======= MODAL DETTAGLI PREVENTIVO ======= -->
    <div id="dettagliModal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="dettagliTitle">
            <button id="closeDettagliBtn" class="close" aria-label="Chiudi">&times;</button>
            <h2 id="dettagliTitle">Dettaglio Preventivo</h2>
            <div class="details-grid">
                <div><label>Numero Ordine</label><div id="det-numeroOrdine"></div></div>
                <div><label>Nome</label><div id="det-nomeCliente"></div></div>
                <div><label>Cognome</label><div id="det-cognomeCliente"></div></div>
                <div><label>Data Nascita</label><div id="det-nascitaCliente"></div></div>
                <div><label>Codice Fiscale</label><div id="det-codiceFiscale"></div></div>
                <div><label>Tipo</label><div id="det-tipo"></div></div>
                <div><label>Codice</label><div id="det-codice"></div></div>
                <div><label>Descrizione</label><div id="det-descrizione"></div></div>
                <div><label>Unità Misura</label><div id="det-unitaMisura"></div></div>
                <div><label>Quantità</label><div id="det-quantita"></div></div>
                <div><label>Prezzo Unitario</label><div id="det-prezzoUnitario"></div></div>
                <div><label>Prezzo Totale</label><div id="det-prezzoTotale"></div></div>
                <div><label>MR Prezzo Unitario</label><div id="det-mrPrezzoUnitario"></div></div>
                <div><label>MR Prezzo Totale</label><div id="det-mrPrezzoTotale"></div></div>
                <div><label>MR Ricarico</label><div id="det-mrRicarico"></div></div>
                <div><label>Mano R Prezzo Unitario</label><div id="det-manoRprezzoUnitario"></div></div>
                <div><label>Mano R Prezzo Totale</label><div id="det-manoRprezzoTotale"></div></div>
                <div><label>Mano R Ricarico</label><div id="det-manoRricarico"></div></div>
                <div><label>PM Prezzo Unitario</label><div id="det-pmPrezzoUnitario"></div></div>
                <div><label>PM Prezzo Totale</label><div id="det-pmPrezzoTotale"></div></div>
                <div><label>CM Prezzo Unitario</label><div id="det-cmPrezzoUnitario"></div></div>
                <div><label>CM Prezzo Totale</label><div id="det-cmPrezzoTotale"></div></div>
            </div>
        </div>
    </div>

    <script>
    (function(){
        var openBtn = document.getElementById('openModalBtn');
        var modal = document.getElementById('preventivoModal');
        var closeBtn = document.getElementById('closeModalBtn');
        var clearBtn = document.getElementById('clearFormBtn');
        var firstInput = document.querySelector('#addPreventivoForm input');

        function openModal(){
            modal.setAttribute('aria-hidden', 'false');
            modal.style.display = 'flex';
            if(firstInput) firstInput.focus();
        }
        function closeModal(){
            modal.setAttribute('aria-hidden', 'true');
            modal.style.display = 'none';
            openBtn && openBtn.focus();
        }

        if (openBtn) openBtn.addEventListener('click', function(e){ e.preventDefault(); openModal(); });
        if (closeBtn) closeBtn.addEventListener('click', function(e){ e.preventDefault(); closeModal(); });

        if (clearBtn) {
            clearBtn.addEventListener('click', function(e){
                e.preventDefault();
                var form = document.getElementById('addPreventivoForm');
                if (form) {
                    form.reset();
                    if (firstInput) firstInput.focus();
                }
            });
        }

        // click outside content closes
        if (modal) modal.addEventListener('click', function(e){ if(e.target === modal) closeModal(); });
        // ESC closes
        document.addEventListener('keydown', function(e){ if(e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') closeModal(); });
    })();
    </script>

    <!-- JS per griglia risultati e modale dettagli -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var grid = document.getElementById('risultatiGrid');
        var dettagliModal = document.getElementById('dettagliModal');
        var closeDettagliBtn = document.getElementById('closeDettagliBtn');

        if (grid) {
            var hasResults = grid.dataset.hasResults === 'true';
            if (!hasResults) {
                grid.style.display = 'none';
            }
        }

        var searchForm = document.querySelector('.search-form');
        if (searchForm && grid) {
            searchForm.addEventListener('submit', function() {
                grid.style.display = 'grid';
            });
        }

        function openDettagli(data) {
            var map = {
                'det-numeroOrdine': data.numeroOrdine,
                'det-nomeCliente': data.nomeCliente,
                'det-cognomeCliente': data.cognomeCliente,
                'det-nascitaCliente': data.nascitaCliente,
                'det-codiceFiscale': data.codiceFiscale,
                'det-tipo': data.tipo,
                'det-codice': data.codice,
                'det-descrizione': data.descrizione,
                'det-unitaMisura': data.unitaMisura,
                'det-quantita': data.quantita,
                'det-prezzoUnitario': data.prezzoUnitario,
                'det-prezzoTotale': data.prezzoTotale,
                'det-mrPrezzoUnitario': data.mrPrezzoUnitario,
                'det-mrPrezzoTotale': data.mrPrezzoTotale,
                'det-mrRicarico': data.mrRicarico,
                'det-manoRprezzoUnitario': data.manoRprezzoUnitario,
                'det-manoRprezzoTotale': data.manoRprezzoTotale,
                'det-manoRricarico': data.manoRricarico,
                'det-pmPrezzoUnitario': data.pmPrezzoUnitario,
                'det-pmPrezzoTotale': data.pmPrezzoTotale,
                'det-cmPrezzoUnitario': data.cmPrezzoUnitario,
                'det-cmPrezzoTotale': data.cmPrezzoTotale
            };
            Object.keys(map).forEach(function(id){
                var el = document.getElementById(id);
                if (el) el.textContent = map[id] != null ? map[id] : '';
            });
            dettagliModal.setAttribute('aria-hidden', 'false');
            dettagliModal.style.display = 'flex';
        }

        function closeDettagli(){
            dettagliModal.setAttribute('aria-hidden', 'true');
            dettagliModal.style.display = 'none';
        }

        if (grid) {
            grid.addEventListener('click', function(e){
                var btn = e.target.closest('.view-details-btn');
                if (!btn) return;
                e.preventDefault();
                var card = btn.closest('.result-card');
                if (!card) return;
                var data = {
                    numeroOrdine: card.getAttribute('data-numero-ordine'),
                    nomeCliente: card.getAttribute('data-nome-cliente'),
                    cognomeCliente: card.getAttribute('data-cognome-cliente'),
                    nascitaCliente: card.getAttribute('data-nascita-cliente'),
                    codiceFiscale: card.getAttribute('data-codice-fiscale'),
                    tipo: card.getAttribute('data-tipo'),
                    codice: card.getAttribute('data-codice'),
                    descrizione: card.getAttribute('data-descrizione'),
                    unitaMisura: card.getAttribute('data-unita-misura'),
                    quantita: card.getAttribute('data-quantita'),
                    prezzoUnitario: card.getAttribute('data-prezzo-unitario'),
                    prezzoTotale: card.getAttribute('data-prezzo-totale'),
                    mrPrezzoUnitario: card.getAttribute('data-mr-prezzo-unitario'),
                    mrPrezzoTotale: card.getAttribute('data-mr-prezzo-totale'),
                    mrRicarico: card.getAttribute('data-mr-ricarico'),
                    manoRprezzoUnitario: card.getAttribute('data-mano-r-prezzo-unitario'),
                    manoRprezzoTotale: card.getAttribute('data-mano-r-prezzo-totale'),
                    manoRricarico: card.getAttribute('data-mano-r-ricarico'),
                    pmPrezzoUnitario: card.getAttribute('data-pm-prezzo-unitario'),
                    pmPrezzoTotale: card.getAttribute('data-pm-prezzo-totale'),
                    cmPrezzoUnitario: card.getAttribute('data-cm-prezzo-unitario'),
                    cmPrezzoTotale: card.getAttribute('data-cm-prezzo-totale')
                };
                openDettagli(data);
            });
        }

        if (closeDettagliBtn) {
            closeDettagliBtn.addEventListener('click', function(e){ e.preventDefault(); closeDettagli(); });
        }
        if (dettagliModal) {
            dettagliModal.addEventListener('click', function(e){ if(e.target === dettagliModal) closeDettagli(); });
        }
        document.addEventListener('keydown', function(e){
            if(e.key === 'Escape' && dettagliModal.getAttribute('aria-hidden') === 'false') closeDettagli();
        });
    });
    </script>

</body>
</html>
